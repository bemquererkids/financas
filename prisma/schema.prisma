generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// MÓDULO A: Ledger Mensal (Core)
model Transaction {
  id          String   @id @default(uuid())
  amount      Decimal  @db.Decimal(10, 2)
  description String
  category    String
  subcategory String?
  type        String   // INCOME, EXPENSE
  date        DateTime
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  creditCardId String?
}

// MÓDULO B: Janelas de Pagamento
model PaymentWindow {
  id        String   @id @default(uuid())
  month     String   // YYYY-MM
  windowDay Int      // 7, 15, 30
  receivedAmount Decimal @db.Decimal(10, 2)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  payables  Payable[]
}

model Payable {
  id              String   @id @default(uuid())
  paymentWindowId String
  paymentWindow   PaymentWindow @relation(fields: [paymentWindowId], references: [id], onDelete: Cascade)
  name            String
  amount          Decimal @db.Decimal(10, 2)
  dueDate         DateTime
  isPaid          Boolean @default(false)
}

// MÓDULO C: Envelopes de Planejamento (50/30/20 et al)
model BudgetEnvelope {
  id          String   @id @default(uuid())
  name        String
  targetPercentage Decimal @db.Decimal(5, 2)
  month       String
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// MÓDULO D: Projeções de Investimentos
model InvestmentProjection {
  id               String   @id @default(uuid())
  name             String
  initialBalance   Decimal  @db.Decimal(15, 2)
  monthlyContribution Decimal @db.Decimal(10, 2)
  annualReturnRate Decimal  @db.Decimal(5, 2)
  adminFeeRate     Decimal  @db.Decimal(5, 2)
  years            Int
  createdAt        DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// MÓDULO G: Objetivos
model Goal {
  id          String   @id @default(uuid())
  description String
  targetAmount Decimal? @db.Decimal(15,2)
  status      String
  createdAt   DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// MÓDULO H: Snapshots / Reuniões
model FinancialSnapshot {
  id        String   @id @default(uuid())
  date      DateTime @default(now())
  totalBalance Decimal @db.Decimal(15, 2)
  totalDebt    Decimal @db.Decimal(15, 2)
  notes        String?  @db.Text
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// MÓDULO F: Dívidas
model Debt {
  id             String   @id @default(uuid())
  name           String
  totalValue     Decimal  @db.Decimal(10, 2)
  interestRate   Decimal  @db.Decimal(5, 2)
  monthlyPayment Decimal? @db.Decimal(10, 2)
  remainingValue Decimal? @db.Decimal(10, 2)
  status         String
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth Models
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  phone         String?   @unique // Celular para contato/validação
  image         String?
  password      String?   // Para autenticação com email/senha
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Perfil Financeiro (Onboarding)
  onboardingCompleted Boolean  @default(false)
  financialSituation  String?  // "endividado", "equilibrado", "poupando"
  monthlyIncome       Float?   // Renda mensal média
  hasCreditCard       Boolean  @default(false)
  creditCardCount     Int      @default(0)
  hasInvestments      Boolean  @default(false)
  investmentTypes     String?  // JSON array: ["renda_fixa", "acoes", "fundos"]
  mainGoal            String?  // "quitar_dividas", "poupar", "investir", "controlar_gastos"
  userProfile         String?  // "endividado", "iniciante", "poupador", "investidor"

  // Relations
  transactions      Transaction[]
  paymentWindows    PaymentWindow[]
  budgetEnvelopes   BudgetEnvelope[]
  investments       InvestmentProjection[]
  goals             Goal[]
  snapshots         FinancialSnapshot[]
  debts             Debt[]
  pushSubscriptions PushSubscription[]
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
