
import { createGoogleGenerativeAI } from "@ai-sdk/google";
import { streamText, tool } from 'ai';
import { z } from 'zod';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';

// Actions de Dados
import { getFinancialSummary, getRecentTransactions } from '@/app/actions/financial-actions';
import { getGoals } from '@/app/actions/goal-actions';
import { getDebts } from '@/app/actions/debt-actions';
import { getProjections } from '@/app/actions/investment-actions';
import { getPaymentWindows } from '@/app/actions/payment-actions';

// DB
import { prisma } from '@/lib/prisma';

export const dynamic = 'force-dynamic';
export const maxDuration = 60; // Allow longer generation for tools
const google = createGoogleGenerativeAI({
    apiKey: process.env.GOOGLE_GENERATIVE_AI_API_KEY,
});

export async function POST(req: Request) {
    try {
        const session = await getServerSession(authOptions);
        if (!session?.user?.id) {
            return new Response("Unauthorized", { status: 401 });
        }
        const userId = session.user.id;
        const userName = session.user.name ? session.user.name.split(' ')[0] : "Usu√°rio";

        const { messages } = await req.json();

        console.log("üì® Messages received:", JSON.stringify(messages, null, 2));
        if (!messages || messages.length === 0) {
            return new Response("No messages", { status: 400 });
        }
        // üìä 1. Coleta Massiva de Contexto (GOD MODE)
        const [
            summary,
            recentTransactions,
            goals,
            debts,
            investments,
            paymentWindows
        ] = await Promise.all([
            getFinancialSummary(),
            getRecentTransactions(),
            getGoals(),
            getDebts(),
            getProjections(),
            getPaymentWindows() // M√™s atual by default
        ]);

        // --- Formata√ß√£o dos Dados para o Prompt ---

        // 1. Transa√ß√µes
        const txList = recentTransactions.map(t =>
            `- ${new Date(t.date).toLocaleDateString('pt-BR')} | ${t.description} | R$ ${Number(t.amount).toFixed(2)} (${t.type}) | ${t.category}`
        ).join('\n');

        // 2. Objetivos
        const goalsList = goals.map(g =>
            `- [${g.status === 'COMPLETED' ? '‚úÖ CONCLU√çDO' : 'üéØ PENDENTE'}] ${g.description} ${g.targetAmount ? `(Meta: R$ ${Number(g.targetAmount).toFixed(2)})` : ''}`
        ).join('\n');

        // 3. D√≠vidas
        const debtsList = debts.map(d =>
            `- ${d.name}: Total R$ ${Number(d.totalValue).toFixed(2)} (Restante: R$ ${Number(d.remainingValue).toFixed(2)}) - Parcela: R$ ${Number(d.monthlyPayment).toFixed(2)}`
        ).join('\n');

        // 4. Investimentos
        const investList = investments.map(i =>
            `- ${i.name}: Saldo Inicial R$ ${Number(i.initialBalance).toFixed(2)} | Aporte R$ ${Number(i.monthlyContribution).toFixed(2)}/m√™s`
        ).join('\n');

        // 5. Contas a Pagar (Pagamentos)
        let paymentsList = "Nenhuma conta encontrada para este m√™s.";
        if (paymentWindows && paymentWindows.windows) {
            const list: string[] = [];
            Object.values(paymentWindows.windows).forEach((w: any) => {
                w.items.forEach((item: any) => {
                    list.push(`- Dia ${w.day}: ${item.name} | R$ ${item.amount.toFixed(2)} [${item.isPaid ? 'üü¢ PAGO' : 'üî¥ PENDENTE'}]`);
                });
            });
            if (list.length > 0) paymentsList = list.join('\n');
        }

        // üìä 0. Coleta do Perfil do Usu√°rio
        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: {
                financialSituation: true,
                monthlyIncome: true,
                userProfile: true,
                mainGoal: true,
            }
        });

        // --- Montagem do Prompt do Sistema ---
        const contextData = `
DADOS DO USU√ÅRIO (${userName}):
- Perfil: ${user?.userProfile || 'N√£o definido'}
- Situa√ß√£o: ${user?.financialSituation || 'N√£o definida'}
- Renda Mensal: R$ ${user?.monthlyIncome?.toFixed(2) || '0.00'}
- Objetivo Principal: ${user?.mainGoal || 'N√£o definido'}

- Data Hoje: ${new Date().toLocaleDateString('pt-BR')}
- Saldo Atual: R$ ${summary.balance.toFixed(2)}
- Receitas (M√™s): R$ ${summary.income.toFixed(2)}
- Despesas (M√™s): R$ ${summary.expenses.toFixed(2)}

üéØ OBJETIVOS:
${goalsList.length > 0 ? goalsList : "Nenhum cadastrado."}

üí∏ D√çVIDAS ATIVAS:
${debtsList.length > 0 ? debtsList : "Nenhuma d√≠vida cadastrada."}

üìÖ CONTAS DO M√äS (Pagamentos):
${paymentsList}

üìà INVESTIMENTOS (Proje√ß√µes):
${investList.length > 0 ? investList : "Nenhum investimento cadastrado."}

üìù √öLTIMAS TRANSA√á√ïES:
${txList.length > 0 ? txList : "Nenhuma transa√ß√£o recente."}
`;

        const systemPrompt = `Voc√™ √© o 'Agente Financeiro', um parceiro de organiza√ß√£o financeira de ${userName}.
**REGRA PRIMORDIAL: Toda a sua comunica√ß√£o deve ser estritamente em Portugu√™s do Brasil (pt-BR).**

Seu objetivo √© trazer tranquilidade e clareza. Use um tom **colaborativo, leve e organizado** ("Vamos resolver tudo", "Um passo de cada vez").

CONTEXTO DO ONBOARDING:
O usu√°rio tem o perfil: **${user?.userProfile || 'N√£o definido'}**.
Objetivo principal: **${user?.mainGoal || 'N√£o definido'}**.
Renda informada (Base): **R$ ${user?.monthlyIncome?.toFixed(2) || 'N√£o informada'}**.

DIRETRIZES DE RESPOSTA:
1. **Comece pelo Positivo**: Se o usu√°rio n√£o tem dados, use a renda informada como ponto de partida. ex: "Vi que sua renda √© de R$ ${user?.monthlyIncome}. Que tal come√ßarmos registrando seus gastos fixos?"
2. **Seja Organizado, n√£o Cr√≠tico**: Se tiver d√≠vidas, diga: "Vamos organizar isso. O segredo √© listar tudo para tra√ßarmos um plano."
3. **Sem Press√£o**: Evite termos alarmistas. Use "Oportunidade de melhoria", "Ajuste necess√°rio", "Planejamento".
4. **Respostas Curtas e Pr√°ticas**: D√™ *um* pr√≥ximo passo claro por vez.

CONHECIMENTO SOBRE INVESTIMENTOS:
Se o usu√°rio perguntar sobre investir, diversificar ou onde aplicar dinheiro, voc√™ pode orientar:
- SEMPRE mencione PRIMEIRO: Reserva de Emerg√™ncia (3-6 meses de despesas em Tesouro Selic ou CDB liquidez di√°ria)
- Perfil Conservador: 40% Reserva + 50% Renda Fixa (CDB, Tesouro IPCA+) + 10% Fundos DI
- Perfil Moderado: 25% Reserva + 40% Renda Fixa + 25% ETFs (BOVA11) + 10% FIIs
- Perfil Arrojado: 15% Reserva + 25% Renda Fixa + 45% A√ß√µes/ETFs + 15% Alternativos
- Corretoras para abrir conta: XP, Rico, Clear, BTG, Nubank
- NUNCA prometa rentabilidade garantida ou d√™ dicas de a√ß√µes espec√≠ficas


---
${contextData}
---

REGRAS T√âCNICAS:
- Responda SEMPRE em Portugu√™s do Brasil.
- N√£o invente valores que n√£o est√£o no contexto.
- Se o usu√°rio pedir para adicionar algo, use as tools dispon√≠veis.
`;

        // üöÄ Google Gemini 2.0 Flash
        const result = await streamText({
            model: google('gemini-2.0-flash'),
            system: systemPrompt,
            messages,
            maxSteps: 5,
            tools: {
                add_transaction: tool({
                    description: 'Salvar uma transa√ß√£o no banco de dados.',
                    parameters: z.object({
                        description: z.string(),
                        amount: z.number(),
                        type: z.enum(['INCOME', 'EXPENSE']),
                        category: z.string(),
                        date: z.string(),
                    }),
                    execute: async (params: any) => {
                        const { description, amount, type, category, date } = params;
                        console.log('üõ†Ô∏è [TOOL] Registrando:', { description, amount, type, category, date });
                        try {
                            const transaction = await prisma.transaction.create({
                                data: {
                                    userId,
                                    description,
                                    amount: Number(amount),
                                    type: type as any,
                                    category: category.toUpperCase(),
                                    date: new Date(date),
                                    isRecurring: false
                                }
                            });
                            return { success: true, id: transaction.id };
                        } catch (error) {
                            console.error('‚ùå Erro Tool:', error);
                            return { success: false, error: 'Erro no Banco' };
                        }
                    }
                })
            }
        });

        return result.toDataStreamResponse();

    } catch (error) {
        console.error('Chat API Error:', error);
        return new Response('Error processing chat request', { status: 500 });
    }
}
